version: "3.7"

services:
  # Nacos
  nacos:
    image: ustc-edu-cn.mirror.aliyuncs.com/nacos/nacos-server
    restart: unless-stopped
    env_file:
      - ./nacos/nacos-standlone-mysql.env
    volumes:
      - ./nacos/standalone-logs/:/home/nacos/logs
      - ./nacos/init.d/custom.properties:/home/nacos/init.d/custom.properties
    # 仅测试用，可以去除
    ports:
      - "8848:8848"
      - "9848:9848"
      - "9555:9555"
    depends_on:
      - mysql

  # Nacos 数据库
  mysql:
    image: ustc-edu-cn.mirror.aliyuncs.com/nacos/nacos-mysql:8.0.16
    restart: unless-stopped
    env_file:
      - ./nacos/mysql.env
    # 仅测试用，可以去除
    ports:
      - "13306:3306"
    volumes:
      - ./nacos/mysql:/var/lib/mysql
      - ./nacos/db-dump:/docker-entrypoint-initdb.d/

  # openGauss 数据库
  opengauss:
    image: ustc-edu-cn.mirror.aliyuncs.com/enmotech/opengauss:2.1.0
    restart: unless-stopped
    privileged: true
    user: 0:0
    environment:
      # 测试用
      GS_PASSWORD: Secretpassword@123
    # 仅测试用，可以去除
    ports:
      - "5432:5432"
    volumes:
      - ./opengauss/db_data:/var/lib/opengauss

  # 授权认证模块
  mall-auth:
    build:
      context: mall-auth
    image: frogsoftware/mall-auth:0.0.1
    restart: unless-stopped
    environment:
      PORT: ${AUTH_PORT:-9000}
      NACOS_URL: nacos
      OPENGAUSS_URL: opengauss
    # 仅测试用，可以去除
    ports:
      - "${AUTH_PORT:-9000}:${AUTH_PORT:-9000}"
    depends_on:
      - nacos
      - opengauss

  # 服务网关
  mall-gateway:
    build:
      context: mall-gateway
    image: frogsoftware/mall-gateway:0.0.1
    restart: unless-stopped
    environment:
      PORT: ${GATEWAY_PORT:-8080}
      NACOS_URL: nacos
    ports:
      - "${GATEWAY_PORT:-8080}:${GATEWAY_PORT:-8080}"
    depends_on:
      - mall-auth
      - mall-user
      - mall-shop
      - mall-commodity

  # 用户模块
  mall-user:
    build:
      context: mall-user
    image: frogsoftware/mall-user:0.0.1
    restart: unless-stopped
    environment:
      PORT: ${USER_PORT:-9100}
      NACOS_URL: nacos
      OPENGAUSS_URL: opengauss
    # 仅测试用，可以去除
    ports:
      - "${USER_PORT:-9100}:${USER_PORT:-9100}"
    depends_on:
      - nacos
      - opengauss

  # 商店模块
  mall-shop:
    build:
      context: mall-shop
    image: frogsoftware/mall-shop:0.0.1
    restart: unless-stopped
    environment:
      PORT: ${SHOP_PORT:-9210}
      NACOS_URL: nacos
      OPENGAUSS_URL: opengauss
    # 仅测试用，可以去除
    ports:
      - "${SHOP_PORT:-9210}:${SHOP_PORT:-9210}"
    depends_on:
      - nacos
      - opengauss

  # 商品模块
  mall-commodity:
    build:
      context: mall-commodity
    image: frogsoftware/mall-commodity:0.0.1
    restart: unless-stopped
    environment:
      PORT: ${COMMODITY_PORT:-9200}
      NACOS_URL: nacos
      OPENGAUSS_URL: opengauss
    # 仅测试用，可以去除
    ports:
      - "${COMMODITY_PORT:-9200}:${COMMODITY_PORT:-9200}"
    depends_on:
      - nacos
      - opengauss
